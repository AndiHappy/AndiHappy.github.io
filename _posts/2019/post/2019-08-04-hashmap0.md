---
layout: post
title: "沉下心来分析HashMap的源码（四）学习红黑树"
subtitle: "红黑树相关的操作，尽可能的详细"
author: "zhailzh"  
header-img: "img/post-bg-2015.jpg"  
catalog: true
tags: JDK  
---

  HashMap的源码在JDK 1.8后引入了红黑树，但是看到红黑树的定义：

1. 每个节点或者是红色，或者是黑色
2. 根节点是黑色
3. 每一个叶子节点(最后的空节点)是黑色的
4. 如果一个节点是红色的，那么它的孩子节点都是黑色的
5. 从任意一个节点到叶子节点，经过的黑色节点是一样的

完全的不清楚为什么这么定义，以及这么定义的原因是什么。

<!--more-->

### 先导

先说红黑树的由来，是为了查找的平衡，从二叉查找树说起。

二叉查找树：从根节点开始，左节点的值小于根节点，右节点的值大于右节点。并且每一颗子树都满足这个条件，所以便于查找：查找的时候，只需要比对就能够瞬速的找到所在子树，继而找到对应的节点。但是二叉查找树有一个缺点就是：容易偏向一侧，我们向往的二叉查找树是图一，结果却有很多图二的情况。
![图1]()
![图2]()

### 平衡树：2-3树
在这种需求下，平衡树的概念就应运而生了。红黑树就是一种平衡树，它可以保证二叉树基本符合我们预料的那种平衡的结构，但是理解红黑树之前，必须先了解另一种树，叫2-3树，红黑树背后的逻辑就是它。

2-3树：2-3树满足二分搜索树的性质。不同的是在2-3树中，存在两种节点。一种是有两个叶子节点的，我们称作“2节点” 如图3；另一种是有三个叶子节点的，我们称作“3节点”，如图4，图5展示的是一个完整的2-3 树，满足从根节点到任意一个叶子节点的高度都是相同的。
![图3]()
![图4]()
![图5]()

### 2-3树如何保持平衡

2-3树平衡的保持，主要依赖两个操作：拆分和合并。其中拆分主要发生在3节点插入时候，如下图6，图7完整的展示可一个查分的过程：
![图6]()
![图7]()
拆分的过程主要是形成了一个4节点（类似于2节点，3节点的概念），然后通过4节点的中间状态查分为三个2节点.但是在图7的第三步，拆分过后的2-3树已经不满足：从根节点到任意的叶子节点的高度是完全一致的平衡性，所以我们需要合并的操作，如图7中的第4步。如果合并过程中，出现了四节点，那么我们再次的查分，这两个操作可以混合使用，如图8.
![图8]()

### 2-3树和红黑树的关系

对于2-3树中的“2节点”，对应于红黑树中的“黑节点”，即相当于普通二分搜索树中的一个节点。

对于2-3树中的“3节点”，相当于普通二分搜索树中的两个节点融合在一起，我们如何来描述这种融合在一起的两个节点之间的关系呢？其实很简单，如果我们将连接这两个节点的边涂成红色，就可以表示这两个节点是融合的关系，即2-3树中的一个“3节点”。那么问题又来了，对于树这种数据结构，我们在定义的时候通常都是针对节点进行定义，并没有对节点之间的边进行定义，我们如何来表示这条被涂成红色的边呢？大家都知道，对于树中的任意一个节点，都是只有一个父亲节点，所以与其父节点相连接的边可以用该节点进行表示。那么我们就可以将这两个节点中较小的节点（作为左子树的节点）涂成红色，就可以很好地表示这两个节点融合的关系了。

http://redmapleren.com/2018/09/23/%E5%85%B3%E4%BA%8E%E7%BA%A2%E9%BB%91%E6%A0%91%E7%9A%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/


2-3树是二叉查找树的变种，树中的2和3代表两种节点，以下表示为2-节点和3-节点。

    2-节点即普通节点：包含一个元素，两条子链接。

    3-节点则是扩充版，包含2个元素和三条链接：两个元素A、B，左边的链接指向小于A的节点，中间的链接指向介于A、B值之间的节点，右边的链接指向大于B的节点。
