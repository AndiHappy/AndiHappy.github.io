<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="andihappy" />
    <meta name="viewport" content="width=device-width">
    <title>SpringMVC 中找到响应URL的具体的方法 | andihappy</title>
	<!-- Jim disable
	script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?autoload=true&skin=Desert"></script-->
    <link href="/feed/" rel="alternate" title="andihappy" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/highlight.css">
    <link href='/media/webfonts/ss-social.css' rel='stylesheet'>
    <link href='/media/webfonts/ss-standard.css' rel='stylesheet'>

    <script language="JavaScript"><!--
        if (navigator.userAgent.match(/iPhone|iPod|Android|IEMobile/i)) {
            document.write("<link href=\"/media/css/screen-mobil.css\" rel=\"stylesheet\">");
        } else {
            document.write("<link href=\"/media/css/screen.css\" rel=\"stylesheet\">");
        }
        // -->
    </script>

    <!--script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script-->
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.2.min.js"></script>

  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <div class="buttons">
          <a href="/" class="ss-icon" title="Go to homepage">home</a>
          <a href="/categories" class="ss-icon" title="Category" >list</a>
          <a href="/tags" class="ss-icon" title="Tag Cloud" >tags</a>
          <a href="/guestbook" class="ss-icon" title="Guest Book" >talk</a>
          <a href="/about" class="ss-icon" title="About" >user</a>
          <a href="/feed" class="ss-icon" title="Subscribe by RSS" >rss</a>
		 <a href="/demo" class="ss-icon" title="Demo" >heart</a>
        </div>
        <h1>SpringMVC 中找到响应URL的具体的方法</h1>
        </header>
        <hr>
        <article class="content">
        <section class="post">
<blockquote>
  <p>SpringMVC 找到响应URL请求的方法</p>
</blockquote>

<blockquote>
  <p><strong>向之所欣，俯仰之间，已为陈迹，犹不能不以之兴怀</strong><br />
疲惫期，慢慢在堕落</p>
</blockquote>

<p>URL请求到： org.springframework.web.servlet.DispatcherServlet.doDispatch(HttpServletRequest, HttpServletResponse) 的时候，得到handler的时候：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// Determine handler adapter for the current request.</span>
				<span class="n">HandlerAdapter</span> <span class="n">ha</span> <span class="o">=</span> <span class="n">getHandlerAdapter</span><span class="o">(</span><span class="n">mappedHandler</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>

</code></pre>
</div>

<p>针对于Handler中定义的Controller的类信息的解析，最终生成一个：ServletHandlerMethodResolver 实例，其初始化的逻辑是：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">handlerType</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">handlerTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span>
		<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">specificHandlerType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">Proxy</span><span class="o">.</span><span class="na">isProxyClass</span><span class="o">(</span><span class="n">handlerType</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">handlerTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">handlerType</span><span class="o">);</span>
			<span class="n">specificHandlerType</span> <span class="o">=</span> <span class="n">handlerType</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">handlerTypes</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">handlerType</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">()));</span>
		<span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">currentHandlerType</span> <span class="o">:</span> <span class="n">handlerTypes</span><span class="o">)</span> <span class="o">{</span>
			<span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">specificHandlerType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">specificHandlerType</span> <span class="o">:</span> <span class="n">currentHandlerType</span><span class="o">);</span>
			<span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">doWithMethods</span><span class="o">(</span><span class="n">currentHandlerType</span><span class="o">,</span> <span class="k">new</span> <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">MethodCallback</span><span class="o">()</span> <span class="o">{</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="n">doWith</span><span class="o">(</span><span class="n">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">Method</span> <span class="n">specificMethod</span> <span class="o">=</span> <span class="n">ClassUtils</span><span class="o">.</span><span class="na">getMostSpecificMethod</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">);</span>
					<span class="n">Method</span> <span class="n">bridgedMethod</span> <span class="o">=</span> <span class="n">BridgeMethodResolver</span><span class="o">.</span><span class="na">findBridgedMethod</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">isHandlerMethod</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
							<span class="o">(</span><span class="n">bridgedMethod</span> <span class="o">==</span> <span class="n">specificMethod</span> <span class="o">||</span> <span class="o">!</span><span class="n">isHandlerMethod</span><span class="o">(</span><span class="n">bridgedMethod</span><span class="o">)))</span> <span class="o">{</span>
							<span class="c1">//关键就是这句，把controller实现类的继承类，以及自身的响应的URL的方法全部的放到handlerMethods中①</span>
						<span class="n">handlerMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isInitBinderMethod</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
							<span class="o">(</span><span class="n">bridgedMethod</span> <span class="o">==</span> <span class="n">specificMethod</span> <span class="o">||</span> <span class="o">!</span><span class="n">isInitBinderMethod</span><span class="o">(</span><span class="n">bridgedMethod</span><span class="o">)))</span> <span class="o">{</span>
						<span class="n">initBinderMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isModelAttributeMethod</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
							<span class="o">(</span><span class="n">bridgedMethod</span> <span class="o">==</span> <span class="n">specificMethod</span> <span class="o">||</span> <span class="o">!</span><span class="n">isModelAttributeMethod</span><span class="o">(</span><span class="n">bridgedMethod</span><span class="o">)))</span> <span class="o">{</span>
						<span class="n">modelAttributeMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">},</span> <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">USER_DECLARED_METHODS</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">this</span><span class="o">.</span><span class="na">typeLevelMapping</span> <span class="o">=</span> <span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">handlerType</span><span class="o">,</span> <span class="n">RequestMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">SessionAttributes</span> <span class="n">sessionAttributes</span> <span class="o">=</span> <span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">handlerType</span><span class="o">,</span> <span class="n">SessionAttributes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">sessionAttributesFound</span> <span class="o">=</span> <span class="o">(</span><span class="n">sessionAttributes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sessionAttributesFound</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">sessionAttributeNames</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">sessionAttributes</span><span class="o">.</span><span class="na">value</span><span class="o">()));</span>
			<span class="k">this</span><span class="o">.</span><span class="na">sessionAttributeTypes</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">sessionAttributes</span><span class="o">.</span><span class="na">types</span><span class="o">()));</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre>
</div>

<p>然后就是执行：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">try</span> <span class="o">{</span>
					<span class="c1">// Actually invoke the handler.</span>
					<span class="n">mv</span> <span class="o">=</span> <span class="n">ha</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">processedRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">mappedHandler</span><span class="o">.</span><span class="na">getHandler</span><span class="o">());</span>
				<span class="o">}</span>
</code></pre>
</div>

<p>最主要的一个方法：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">protected</span> <span class="n">ModelAndView</span> <span class="nf">invokeHandlerMethod</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="c1">//① 根据handler得到ServletHandlerMethodResolver，其中保存了handler的所有的URL请求的响应的</span>
		<span class="n">ServletHandlerMethodResolver</span> <span class="n">methodResolver</span> <span class="o">=</span> <span class="n">getMethodResolver</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
		<span class="c1">//②找到针对特定URL的方法</span>
		<span class="n">Method</span> <span class="n">handlerMethod</span> <span class="o">=</span> <span class="n">methodResolver</span><span class="o">.</span><span class="na">resolveHandlerMethod</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
		<span class="n">ServletHandlerMethodInvoker</span> <span class="n">methodInvoker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletHandlerMethodInvoker</span><span class="o">(</span><span class="n">methodResolver</span><span class="o">);</span>
		<span class="n">ServletWebRequest</span> <span class="n">webRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServletWebRequest</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="n">ExtendedModelMap</span> <span class="n">implicitModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BindingAwareModelMap</span><span class="o">();</span>
		<span class="c1">//执行方法</span>
		<span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">methodInvoker</span><span class="o">.</span><span class="na">invokeHandlerMethod</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="n">webRequest</span><span class="o">,</span> <span class="n">implicitModel</span><span class="o">);</span>
		<span class="n">ModelAndView</span> <span class="n">mav</span> <span class="o">=</span>
				<span class="n">methodInvoker</span><span class="o">.</span><span class="na">getModelAndView</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">,</span> <span class="n">handler</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">result</span><span class="o">,</span> <span class="n">implicitModel</span><span class="o">,</span> <span class="n">webRequest</span><span class="o">);</span>
		<span class="n">methodInvoker</span><span class="o">.</span><span class="na">updateModelAttributes</span><span class="o">(</span><span class="n">handler</span><span class="o">,</span> <span class="o">(</span><span class="n">mav</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mav</span><span class="o">.</span><span class="na">getModel</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">),</span> <span class="n">implicitModel</span><span class="o">,</span> <span class="n">webRequest</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">mav</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre>
</div>
<p>第一步的得到controller的方法的信息，这个是利用了缓存，最初的时候是解析controller类，把能够支持URL的请求的全部的找出来，放到一个Map中：</p>

<p><img src="http://7xtrwx.com1.z0.glb.clouddn.com/9c49ce4c797e7df438fc9bd68a1d3240.png" alt="controller的方法" /></p>

<p>有意思的是这个map的key值是Method，value是URL对应的映射的信息。</p>

<p>另外HandlerMethods这个成员变量是一个链表的样式：</p>

<p><img src="http://7xtrwx.com1.z0.glb.clouddn.com/bca6fa55fbcf3cbfe5e247fba8e9f8a1.png" alt="controller的handler" /></p>

<p>这样就能够看到为什么Map的key值是Method了？</p>

<p>第二步的具体的代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>		<span class="kd">public</span> <span class="n">Method</span> <span class="nf">resolveHandlerMethod</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
			<span class="n">String</span> <span class="n">lookupPath</span> <span class="o">=</span> <span class="n">urlPathHelper</span><span class="o">.</span><span class="na">getLookupPathForRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
			<span class="n">Comparator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">pathComparator</span> <span class="o">=</span> <span class="n">pathMatcher</span><span class="o">.</span><span class="na">getPatternComparator</span><span class="o">(</span><span class="n">lookupPath</span><span class="o">);</span>
			<span class="n">Map</span><span class="o">&lt;</span><span class="n">RequestSpecificMappingInfo</span><span class="o">,</span> <span class="n">Method</span><span class="o">&gt;</span> <span class="n">targetHandlerMethods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">RequestSpecificMappingInfo</span><span class="o">,</span> <span class="n">Method</span><span class="o">&gt;();</span>
			<span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">allowedMethods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="mi">7</span><span class="o">);</span>
			<span class="n">String</span> <span class="n">resolvedMethodName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="c1">//得到controller的所有的处理url的方法</span>
			<span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">handlerMethod</span> <span class="o">:</span> <span class="n">getHandlerMethods</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">//得到对应的映射的信息</span>
				<span class="n">RequestSpecificMappingInfo</span> <span class="n">mappingInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestSpecificMappingInfo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">));</span>
				<span class="kt">boolean</span> <span class="n">match</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">hasPatterns</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">pattern</span> <span class="o">:</span> <span class="n">mappingInfo</span><span class="o">.</span><span class="na">getPatterns</span><span class="o">())</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">hasTypeLevelMapping</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pattern</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/"</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">pattern</span> <span class="o">=</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">pattern</span><span class="o">;</span>
						<span class="o">}</span>
						<span class="c1">//找到全路径的URL</span>
						<span class="n">String</span> <span class="n">combinedPattern</span> <span class="o">=</span> <span class="n">getCombinedPattern</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span> <span class="n">lookupPath</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">combinedPattern</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
								<span class="n">match</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
								<span class="n">mappingInfo</span><span class="o">.</span><span class="na">addMatchedPattern</span><span class="o">(</span><span class="n">combinedPattern</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">else</span> <span class="o">{</span>
								<span class="k">if</span> <span class="o">(!</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">matchesRequestMethod</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
									<span class="n">allowedMethods</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">methodNames</span><span class="o">());</span>
								<span class="o">}</span>
								<span class="k">break</span><span class="o">;</span>
							<span class="o">}</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="n">mappingInfo</span><span class="o">.</span><span class="na">sortMatchedPatterns</span><span class="o">(</span><span class="n">pathComparator</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">useTypeLevelMapping</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">String</span><span class="o">[]</span> <span class="n">typeLevelPatterns</span> <span class="o">=</span> <span class="n">getTypeLevelMapping</span><span class="o">().</span><span class="na">value</span><span class="o">();</span>
					<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">typeLevelPattern</span> <span class="o">:</span> <span class="n">typeLevelPatterns</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">typeLevelPattern</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/"</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">typeLevelPattern</span> <span class="o">=</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">typeLevelPattern</span><span class="o">;</span>
						<span class="o">}</span>
						<span class="kt">boolean</span> <span class="n">useSuffixPattern</span> <span class="o">=</span> <span class="n">useSuffixPattern</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
						<span class="c1">//匹配URL的方法⑤</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">getMatchingPattern</span><span class="o">(</span><span class="n">typeLevelPattern</span><span class="o">,</span> <span class="n">lookupPath</span><span class="o">,</span> <span class="n">useSuffixPattern</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
								<span class="n">match</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
								<span class="n">mappingInfo</span><span class="o">.</span><span class="na">addMatchedPattern</span><span class="o">(</span><span class="n">typeLevelPattern</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">else</span> <span class="o">{</span>
								<span class="k">if</span> <span class="o">(!</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">matchesRequestMethod</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
									<span class="n">allowedMethods</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">methodNames</span><span class="o">());</span>
								<span class="o">}</span>
								<span class="k">break</span><span class="o">;</span>
							<span class="o">}</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="n">mappingInfo</span><span class="o">.</span><span class="na">sortMatchedPatterns</span><span class="o">(</span><span class="n">pathComparator</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="c1">// No paths specified: parameter match sufficient.</span>
					<span class="n">match</span> <span class="o">=</span> <span class="n">mappingInfo</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">mappingInfo</span><span class="o">.</span><span class="na">getMethodCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mappingInfo</span><span class="o">.</span><span class="na">getParamCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
							<span class="n">resolvedMethodName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">resolvedMethodName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
						<span class="n">match</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">matchesRequestMethod</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">allowedMethods</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">methodNames</span><span class="o">());</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">match</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">Method</span> <span class="n">oldMappedMethod</span> <span class="o">=</span> <span class="n">targetHandlerMethods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">mappingInfo</span><span class="o">,</span> <span class="n">handlerMethod</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">oldMappedMethod</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">oldMappedMethod</span> <span class="o">!=</span> <span class="n">handlerMethod</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">methodNameResolver</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mappingInfo</span><span class="o">.</span><span class="na">hasPatterns</span><span class="o">())</span> <span class="o">{</span>
							<span class="k">if</span> <span class="o">(!</span><span class="n">oldMappedMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
								<span class="k">if</span> <span class="o">(</span><span class="n">resolvedMethodName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
									<span class="n">resolvedMethodName</span> <span class="o">=</span> <span class="n">methodNameResolver</span><span class="o">.</span><span class="na">getHandlerMethodName</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
								<span class="o">}</span>
								<span class="k">if</span> <span class="o">(!</span><span class="n">resolvedMethodName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">oldMappedMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
									<span class="n">oldMappedMethod</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
								<span class="o">}</span>
								<span class="k">if</span> <span class="o">(!</span><span class="n">resolvedMethodName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">handlerMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
									<span class="k">if</span> <span class="o">(</span><span class="n">oldMappedMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
										<span class="n">targetHandlerMethods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">mappingInfo</span><span class="o">,</span> <span class="n">oldMappedMethod</span><span class="o">);</span>
										<span class="n">oldMappedMethod</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
									<span class="o">}</span>
									<span class="k">else</span> <span class="o">{</span>
										<span class="n">targetHandlerMethods</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">mappingInfo</span><span class="o">);</span>
									<span class="o">}</span>
								<span class="o">}</span>
							<span class="o">}</span>
						<span class="o">}</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">oldMappedMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
									<span class="s">"Ambiguous handler methods mapped for HTTP path '"</span> <span class="o">+</span> <span class="n">lookupPath</span> <span class="o">+</span> <span class="s">"': {"</span> <span class="o">+</span>
									<span class="n">oldMappedMethod</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">handlerMethod</span> <span class="o">+</span>
									<span class="s">"}. If you intend to handle the same path in multiple methods, then factor "</span> <span class="o">+</span>
									<span class="s">"them out into a dedicated handler class with that path mapped at the type level!"</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">targetHandlerMethods</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">List</span><span class="o">&lt;</span><span class="n">RequestSpecificMappingInfo</span><span class="o">&gt;</span> <span class="n">matches</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">RequestSpecificMappingInfo</span><span class="o">&gt;(</span><span class="n">targetHandlerMethods</span><span class="o">.</span><span class="na">keySet</span><span class="o">());</span>
				<span class="n">RequestSpecificMappingInfoComparator</span> <span class="n">requestMappingInfoComparator</span> <span class="o">=</span>
						<span class="k">new</span> <span class="n">RequestSpecificMappingInfoComparator</span><span class="o">(</span><span class="n">pathComparator</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
				<span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">matches</span><span class="o">,</span> <span class="n">requestMappingInfoComparator</span><span class="o">);</span>
				<span class="n">RequestSpecificMappingInfo</span> <span class="n">bestMappingMatch</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
				<span class="n">String</span> <span class="n">bestMatchedPath</span> <span class="o">=</span> <span class="n">bestMappingMatch</span><span class="o">.</span><span class="na">bestMatchedPattern</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">bestMatchedPath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">extractHandlerMethodUriTemplates</span><span class="o">(</span><span class="n">bestMatchedPath</span><span class="o">,</span> <span class="n">lookupPath</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">targetHandlerMethods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bestMappingMatch</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">allowedMethods</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="n">HttpRequestMethodNotSupportedException</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">toStringArray</span><span class="o">(</span><span class="n">allowedMethods</span><span class="o">));</span>
				<span class="o">}</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchRequestHandlingMethodException</span><span class="o">(</span><span class="n">lookupPath</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameterMap</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>
</code></pre>
</div>

</section>



<section class="meta">
  <br/>
  <br/>
<span class="sub_pagination">
  
    <a class="sub_pagination-item newer" href="/2016/08/12/">上一篇&nbsp  一周学习总结 <i class="fa fa-chain"></i></a>
  
  
    <a class="sub_pagination-item newer" href="/2016/08/10/">下一篇 &nbsp 从自己所做的工程开始梳理自己技术栈 <i class="fa fa-share"></i></a>
  
  </span>
  <br/>
  <br/>
</section>
<!--<span class="author">
  <a href="http://blog.sevenche.com">andihappy</a> - 程序员，企业管理与互联网结合应用的爱好者，现就职于北京。
</span>
<br /> 
</br>
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="/categories/#梳理基础" title="梳理基础">梳理基础</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="/tags/#梳理基础" title="梳理基础">梳理基础</a>&nbsp;
  
</span>

<span class="time">
  <br/>
  <time datetime="2016-08-03">2016-08-03</time>
</span>
!-->



<section  class="comment">
<!-- baidu JIA -->
<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a title="分享到QQ空间" href="#" class="bds_qzone" data-cmd="qzone"></a><a title="分享到新浪微博" href="#" class="bds_tsina" data-cmd="tsina"></a><a title="分享到腾讯微博" href="#" class="bds_tqq" data-cmd="tqq"></a><a title="分享到人人网" href="#" class="bds_renren" data-cmd="renren"></a><a title="分享到微信" href="#" class="bds_weixin" data-cmd="weixin"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
<!-- end of baidu JIA -->
<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"flyBread"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
</section>


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = 'http://andihappy.github.io//2016/08/10/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = 'http://andihappy.github.io//2016/08/12/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})

</script>

<style type="text/css">
/*resize the big pic*/
div.resized_image p {
  margin: 2px;
  margin-top: 0;
  font-size: 8px;
  /* Awesome icon from here: http://www.famfamfam.com/lab/icons/silk/ */
  background: url(http://i242.photobucket.com/albums/ff244/9861_omikron/error.png) no-repeat;
  padding-left: 20px;
  color: #333;
}
</style>
<script type="text/javascript">
//resize the big pic
$(window).load(function() {
  (
    function(maxht, maxwt, minht, minwt) {
      var imgs = document.getElementsByTagName('img');
      // Image resizing function
      var resize_image = function(img, newht, newwt) {
        img.height = newht;
        img.width  = newwt;
        $(img).wrap('<table><tr><td class="tborder"><div class="resized_image"><a href="' + img.src + '" target="_blank"></a></div></td></tr></table>');
        $(img).parent().before('<p>NOTE: This image was resized. To view it full-size, click on the image.</p>');
        //$(img).parent().after('<p style="text-align:right;background:none;margin:0;padding-right:3px">Image resizing script by <a href="http://aetus.net/217/programming/automatically-resize-large-images-with-javascript/">Aetus Designs</a>.</p>');
      };
      
      for (var i = 0; i < imgs.length; i++) {
        // Set a variable for the current image to make the code make more sense.
        var img = imgs[i];
        if (img.height > maxht || img.width > maxwt) {
          // Use Ratios to constraint proportions.
          var old_ratio = img.height / img.width;
          var min_ratio = minht / minwt;
          // If it can scale perfectly.
          if (old_ratio === min_ratio) {
            resize_image(img, minht, minwt);
          } 
          // We need to do some magic now.
          else {
            var newdim = [img.height, img.width];
            // Sort out the height first.
            newdim[0] = minht;
            // The logic behind this is that if ratio = ht / wt, then wt = ht / ratio.
            newdim[1] = newdim[0] / old_ratio;
            // Do we still have to sort out the width?
            if (newdim[1] > maxwt) {
              // Just do what we did with the height
              newdim[1] = minwt;
              newdim[0] = newdim[1] * old_ratio;
            }
            // So yeah, resize the image
            resize_image(img, newdim[0], newdim[1]);
          }
        }
      }
    }
  )(780, 780, 780, 780);
});
</script>
        </article>
      </div>

    <footer>
        <p><small>Free hosted at <a href="https://github.com/flyBread">Github</a> | Copyright 2014 - 2017
		<!-- *** Please Keep bellow link for at least 6 months! Thanks！*** -->
		<a href="http://flybread.github.io/">Template Maintained by flyBread</a>

		| <span class="label label-info">2017-01-12 20:27:34 CST</span></small></p>
    </footer>

    </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Coder-zhailzh@126.com', 'flyBread.github.io');
  ga('send', 'pageview');

</script>
  </body>
</html>
