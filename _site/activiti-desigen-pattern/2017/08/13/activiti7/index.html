<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="后台服务、微服务、架构、黑客与画家 | 飞翔的面包 JAVA Developer Andi Happy andiHappy | 这里是 飞翔的面包 的个人博客，与你一起发现更大的世界。">
    <meta name="keywords"  content="Andi Happy andiHappy, 飞翔的面包, FlyBread Blog, 博客, 个人网站, 互联网, 后端，服务">
    <meta name="theme-color" content="#000000">
    
    <title>activiti和设计模式(7) - 飞翔的面包 | FlyBread Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/activiti-desigen-pattern/2017/08/13/activiti7/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">飞翔的面包</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
                    <li>
                        <a href="/about/">关于</a>
                    </li>
                    <li>
                        <a href="/tags">标签</a>
                    </li>
                    <li>
                        <a href="/category/">分类</a>
                    </li>
                   <!--  
                    <li>
                        <a href="/category/">分类展示</a>
                    </li>
                    
                    <li>
                        <a href="/portfolio/">Portfolio</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                     -->
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-2015.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-2015.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#学习" title="学习">学习</a>
                        
                    </div>
                    <h1>activiti和设计模式(7)</h1>
                    
                    
                    <h2 class="subheading">activiti中流程定义中节点的跳转</h2>
                    
                    <span class="meta">Posted by zhailzh on August 13, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<p>一个具体的流程启动以后，具体流程示意图：   <br />
<img src="http://7xtrwx.com1.z0.glb.clouddn.com/4e87e67e31be5d65024bf07221129d16.png" alt="简单会签流程示意图" /></p>

<p>追踪流程的运转的情况，找到好玩的代码。  <br />
<!--more-->
根据状态机的跳转的动作：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PROCESS_START = new AtomicOperationProcessStart
||
PROCESS_START_INITIAL = new AtomicOperationProcessStartInitial();
||
ACTIVITY_EXECUTE = new AtomicOperationActivityExecute();
</code></pre></div></div>

<p>我们看到第一个的开始节点的执行：      <br />
<img src="http://7xtrwx.com1.z0.glb.clouddn.com/ed93f1f1941a9f0feba1f9c1b123b15b.png" alt="开始节点的执行" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class NoneStartEventActivityBehavior extends FlowNodeActivityBehavior {

  // Nothing to see here.
  // The default behaviour of the BpmnActivity is exactly what
  // a none start event should be doing.
}
</code></pre></div></div>
<p>实现的在FlowNodeActivityBehavior中</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected BpmnActivityBehavior bpmnActivityBehavior = new BpmnActivityBehavior();

 /**
  * Default behaviour: just leave the activity with no extra functionality.
  */
 public void execute(ActivityExecution execution) throws Exception {
   leave(execution);
 }

 /**
  * Default way of leaving a BPMN 2.0 activity: evaluate the conditions on the
  * outgoing sequence flow and take those that evaluate to true.
  */
 protected void leave(ActivityExecution execution) {
   bpmnActivityBehavior.performDefaultOutgoingBehavior(execution);
 }

 protected void leaveIgnoreConditions(ActivityExecution activityContext) {
   bpmnActivityBehavior.performIgnoreConditionsOutgoingBehavior(activityContext);
 }
</code></pre></div></div>

<p>默认的bpmnActivityBehavior沿着默认的线达到下一个节点，是吗？</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected void performOutgoingBehavior(ActivityExecution execution,
         boolean checkConditions, boolean throwExceptionIfExecutionStuck, List&lt;ActivityExecution&gt; reusableExecutions) {

   if (log.isDebugEnabled()) {
     log.debug("Leaving activity '{}'", execution.getActivity().getId());
   }

   String defaultSequenceFlow = (String) execution.getActivity().getProperty("default");//说明①
   List&lt;PvmTransition&gt; transitionsToTake = new ArrayList&lt;PvmTransition&gt;();

   List&lt;PvmTransition&gt; outgoingTransitions = execution.getActivity().getOutgoingTransitions();
   for (PvmTransition outgoingTransition : outgoingTransitions) {
     Expression skipExpression = outgoingTransition.getSkipExpression();
    //如果不是蹦跳的skipExpression
     if (!SkipExpressionUtil.isSkipExpressionEnabled(execution, skipExpression)) {
       // 没有默认线或者出去的线不是默认线
       if (defaultSequenceFlow == null || !outgoingTransition.getId().equals(defaultSequenceFlow)) {
         Condition condition = (Condition) outgoingTransition.getProperty(BpmnParse.PROPERTYNAME_CONDITION);
         //线上没有条件或者，限定了不检查线上条件，或者线上条件符合要求
         if (condition == null || !checkConditions || condition.evaluate(outgoingTransition.getId(), execution)) {
           transitionsToTake.add(outgoingTransition);
         }
       }

     } else if (SkipExpressionUtil.shouldSkipFlowElement(execution, skipExpression)){
       transitionsToTake.add(outgoingTransition);
     }
   }
   //说明②
   if (transitionsToTake.size() == 1) {
     //只有一条线的时候，直接的走take逻辑
     execution.take(transitionsToTake.get(0));
   } else if (transitionsToTake.size() &gt;= 1) {
     //有多条线的时候
     execution.inactivate();
     if (reusableExecutions == null || reusableExecutions.isEmpty()) {
       execution.takeAll(transitionsToTake, Arrays.asList(execution));
     } else {
       execution.takeAll(transitionsToTake, reusableExecutions);
     }

   } else {
    //没有满足条件出去的线，如果有默认的线
     if (defaultSequenceFlow != null) {
       PvmTransition defaultTransition = execution.getActivity().findOutgoingTransition(defaultSequenceFlow);
       if (defaultTransition != null) {
         execution.take(defaultTransition);
       } else {
         throw new ActivitiException("Default sequence flow '" + defaultSequenceFlow + "' could not be not found");
       }
     } else {
       //如果有补偿事件
       Object isForCompensation = execution.getActivity().getProperty(BpmnParse.PROPERTYNAME_IS_FOR_COMPENSATION);
       if(isForCompensation != null &amp;&amp; (Boolean) isForCompensation) {
         if (execution instanceof ExecutionEntity) {
           Context.getCommandContext().getHistoryManager().recordActivityEnd((ExecutionEntity) execution);
         }
         InterpretableExecution parentExecution = (InterpretableExecution) execution.getParent();
         ((InterpretableExecution)execution).remove();
         parentExecution.signal("compensationDone", null);

       } else {
         //暂停了，抛出错误
         if (log.isDebugEnabled()) {
           log.debug("No outgoing sequence flow found for {}. Ending execution.", execution.getActivity().getId());
         }
         execution.end();

         if (throwExceptionIfExecutionStuck) {
           throw new ActivitiException("No outgoing sequence flow of the inclusive gateway '" + execution.getActivity().getId()
                 + "' could be selected for continuing the process");
         }
       }

     }
   }
 }
</code></pre></div></div>
<p>流程定义节点之间的转移，是先找到满足条件的离开的线：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void take(PvmTransition transition) {
  	take(transition, true);
  }

  public void take(PvmTransition transition, boolean fireActivityCompletionEvent) {

  	if (fireActivityCompletionEvent) {
	  	fireActivityCompletedEvent();
  	}

    if (this.transition!=null) {
      throw new PvmException("already taking a transition");
    }
    if (transition==null) {
      throw new PvmException("transition is null");
    }
    setActivity((ActivityImpl)transition.getSource());
    setTransition((TransitionImpl) transition);
    performOperation(AtomicOperation.TRANSITION_NOTIFY_LISTENER_END);
  }
</code></pre></div></div>
<p>说的转移，只是同一个ExecutionEntity里面的 Activity修改了，Transition修改了，然后开始执行：TRANSITION_NOTIFY_LISTENER_END.  但是和我们想象的不一样，这里设置的Activiti是Transition的Source，也就是“刚刚执行结束”的活动定义：</p>

<p><img src="http://7xtrwx.com1.z0.glb.clouddn.com/ea742aca518a53df8dbeb1f64c8c42c6.png" alt="Execution设置activity" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PROCESS_START = new AtomicOperationProcessStart
||
PROCESS_START_INITIAL = new AtomicOperationProcessStartInitial();
||
ACTIVITY_EXECUTE = new AtomicOperationActivityExecute();
||
TRANSITION_NOTIFY_LISTENER_END = new AtomicOperationTransitionNotifyListenerEnd();
</code></pre></div></div>

<p>执行的过程：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> public void execute(InterpretableExecution execution) {
    ScopeImpl scope = getScope(execution);
    List&lt;ExecutionListener&gt; exectionListeners = scope.getExecutionListeners(getEventName());
    int executionListenerIndex = execution.getExecutionListenerIndex();
    
    if (exectionListeners.size()&gt;executionListenerIndex) {
      execution.setEventName(getEventName());
      execution.setEventSource(scope);
      ExecutionListener listener = exectionListeners.get(executionListenerIndex);
      try {
        listener.notify(execution);
      } catch (RuntimeException e) {
        throw e;
      } catch (Exception e) {
        throw new PvmException("couldn't execute event listener : "+e.getMessage(), e);
      }
      execution.setExecutionListenerIndex(executionListenerIndex+1);
      execution.performOperation(this);//说明①

    } else {
      execution.setExecutionListenerIndex(0);
      execution.setEventName(null);
      execution.setEventSource(null);
      eventNotificationsCompleted(execution);
    }
  }
  
  @Override
  protected void eventNotificationsCompleted(InterpretableExecution execution) {
    execution.performOperation(TRANSITION_DESTROY_SCOPE);
  }
</code></pre></div></div>

<p>说明①: 这个是一个循环调用的，为了循环的发送监听事件
现在运行到了：TRANSITION_DESTROY_SCOPE</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>||
TRANSITION_DESTROY_SCOPE = new AtomicOperationTransitionDestroyScope();
public class AtomicOperationTransitionDestroyScope implements AtomicOperation
</code></pre></div></div>

<p>说明：TRANSITION_DESTROY_SCOPE直接实现了接口，没有像TRANSITION_NOTIFY_LISTENER_END一样，在抽象类的基础方面实现。这可能也是为什么有了接口，还有抽象类的原因？</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void execute(InterpretableExecution execution) {
    InterpretableExecution propagatingExecution = null;

    ActivityImpl activity = (ActivityImpl) execution.getActivity();
    // if this transition is crossing a scope boundary
    if (activity.isScope()) {//当前的任务是否是一个包含的活动节点
      
      InterpretableExecution parentScopeInstance = null;
      // if this is a concurrent execution crossing a scope boundary
      if (execution.isConcurrent() &amp;&amp; !execution.isScope()) {
        // first remove the execution from the current root
        InterpretableExecution concurrentRoot = (InterpretableExecution) execution.getParent();
        parentScopeInstance = (InterpretableExecution) execution.getParent().getParent();

        log.debug("moving concurrent {} one scope up under {}", execution, parentScopeInstance);
        List&lt;InterpretableExecution&gt; parentScopeInstanceExecutions = (List&lt;InterpretableExecution&gt;) parentScopeInstance.getExecutions();
        List&lt;InterpretableExecution&gt; concurrentRootExecutions = (List&lt;InterpretableExecution&gt;) concurrentRoot.getExecutions();
        // if the parent scope had only one single scope child
        if (parentScopeInstanceExecutions.size()==1) {
          // it now becomes a concurrent execution
          parentScopeInstanceExecutions.get(0).setConcurrent(true);
        }
        
        concurrentRootExecutions.remove(execution);
        parentScopeInstanceExecutions.add(execution);
        execution.setParent(parentScopeInstance);
        execution.setActivity(activity);
        propagatingExecution = execution;
        
        // if there is only a single concurrent execution left
        // in the concurrent root, auto-prune it.  meaning, the 
        // last concurrent child execution data should be cloned into
        // the concurrent root.   
        if (concurrentRootExecutions.size()==1) {
          InterpretableExecution lastConcurrent = concurrentRootExecutions.get(0);
          if (lastConcurrent.isScope()) {
            lastConcurrent.setConcurrent(false);
            
          } else {
            log.debug("merging last concurrent {} into concurrent root {}", lastConcurrent, concurrentRoot);
            
            // We can't just merge the data of the lastConcurrent into the concurrentRoot.
            // This is because the concurrent root might be in a takeAll-loop.  So the 
            // concurrent execution is the one that will be receiving the take
            concurrentRoot.setActivity((ActivityImpl) lastConcurrent.getActivity());
            concurrentRoot.setActive(lastConcurrent.isActive());
            lastConcurrent.setReplacedBy(concurrentRoot);
            lastConcurrent.remove();
          }
        }

      } else if (execution.isConcurrent() &amp;&amp; execution.isScope()) {
        log.debug("scoped concurrent {} becomes concurrent and remains under {}", execution, execution.getParent());

        // TODO!
        execution.destroy();
        propagatingExecution = execution;
        
      } else {
        propagatingExecution = (InterpretableExecution) execution.getParent();
        propagatingExecution.setActivity((ActivityImpl) execution.getActivity());
        propagatingExecution.setTransition(execution.getTransition());
        propagatingExecution.setActive(true);
        log.debug("destroy scope: scoped {} continues as parent scope {}", execution, propagatingExecution);
        execution.destroy();
        execution.remove();
      }
      
    } else {
      propagatingExecution = execution;
    }
    
    // if there is another scope element that is ended
    // 父级别的元素，普通元素的父元素是流程定义ProcessDefinition
    ScopeImpl nextOuterScopeElement = activity.getParent();
    TransitionImpl transition = propagatingExecution.getTransition();
    // 目标节点
    ActivityImpl destination = transition.getDestination();
    //判断目标节点是否在父节点中，如果不在（考虑到子流程结束后的下一个元素是子流程以外的元素了）
    if (transitionLeavesNextOuterScope(nextOuterScopeElement, destination)) {
      propagatingExecution.setActivity((ActivityImpl) nextOuterScopeElement);
      //再次进入：TRANSITION_NOTIFY_LISTENER_END
      propagatingExecution.performOperation(TRANSITION_NOTIFY_LISTENER_END);
    } else {
    //进入：TRANSITION_NOTIFY_LISTENER_TAKE
      propagatingExecution.performOperation(TRANSITION_NOTIFY_LISTENER_TAKE);
    }
  }

</code></pre></div></div>

<p>从最后的逻辑，我们可以看到一个循环：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PROCESS_START = new AtomicOperationProcessStart
||
PROCESS_START_INITIAL = new AtomicOperationProcessStartInitial();
||
ACTIVITY_EXECUTE = new AtomicOperationActivityExecute();
||
TRANSITION_NOTIFY_LISTENER_END = new AtomicOperationTransitionNotifyListenerEnd();
||
TRANSITION_DESTROY_SCOPE = new AtomicOperationTransitionDestroyScope();
||
TRANSITION_NOTIFY_LISTENER_TAKE，TRANSITION_NOTIFY_LISTENER_END（第二种情况就是再次的循环一次）
</code></pre></div></div>

<p>TRANSITION_NOTIFY_LISTENER_TAKE 这个就是对应线的逻辑了：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TRANSITION_NOTIFY_LISTENER_TAKE = new AtomicOperationTransitionNotifyListenerTake();
</code></pre></div></div>

<p>执行逻辑：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  public void execute(InterpretableExecution execution) {
    TransitionImpl transition = execution.getTransition();
    
    List&lt;ExecutionListener&gt; executionListeners = transition.getExecutionListeners();
    int executionListenerIndex = execution.getExecutionListenerIndex();
    
    if (executionListeners.size()&gt;executionListenerIndex) {
      execution.setEventName(org.activiti.engine.impl.pvm.PvmEvent.EVENTNAME_TAKE);
      execution.setEventSource(transition);
      ExecutionListener listener = executionListeners.get(executionListenerIndex);
      try {
        listener.notify(execution);
      } catch (RuntimeException e) {
        throw e;
      } catch (Exception e) {
        throw new PvmException("couldn't execute event listener : "+e.getMessage(), e);
      }
      execution.setExecutionListenerIndex(executionListenerIndex+1);
      execution.performOperation(this);
      //上面的这部分逻辑和抽象类里面的逻辑基本的一样
    } else {
    	if (log.isDebugEnabled()) {
    		log.debug("{} takes transition {}", execution, transition);
    	}
      execution.setExecutionListenerIndex(0);
      execution.setEventName(null);
      execution.setEventSource(null);

      ActivityImpl activity = (ActivityImpl) execution.getActivity();
      ActivityImpl nextScope = findNextScope(activity.getParent(), transition.getDestination());
      execution.setActivity(nextScope);//到这里ExecutionEntity的activity才再次的修改，但是Transition并没有修改
      
      // Firing event that transition is being taken     	。。。。。。。。      
      execution.performOperation(TRANSITION_CREATE_SCOPE);
    }
  }
</code></pre></div></div>

<p>然后就到了：TRANSITION_CREATE_SCOPE</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TRANSITION_CREATE_SCOPE = new AtomicOperationTransitionCreateScope();
</code></pre></div></div>
<p>执行逻辑：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void execute(InterpretableExecution execution) {
    InterpretableExecution propagatingExecution = null;
    ActivityImpl activity = (ActivityImpl) execution.getActivity();
    if (activity.isScope()) {//activity扩展自Scope
      // 重新创建了一个Execution，称之为： propagatingExecution
      // 该propagatingExecution的Transition仍然是：(startevent1)--flow1--&gt;(usertask1)
      //并不是Null
      propagatingExecution = (InterpretableExecution) execution.createExecution();
      propagatingExecution.setActivity(activity);
      propagatingExecution.setTransition(execution.getTransition());
      
      execution.setTransition(null);
      execution.setActivity(null);
      execution.setActive(false);
      // Execution的activity，Transition全部都是null
      log.debug("create scope: parent {} continues as execution {}", execution, propagatingExecution);
      propagatingExecution.initialize();

    } else {
      propagatingExecution = execution;
    }
   propagatingExecution.performOperation(AtomicOperation.TRANSITION_NOTIFY_LISTENER_START);
  }
</code></pre></div></div>

<p>到了：AtomicOperation.TRANSITION_NOTIFY_LISTENER_START       <br />
public class AtomicOperationTransitionNotifyListenerStart extends AbstractEventAtomicOperation   <br />
扩展自抽象类：AbstractEventAtomicOperation    具体的执行的过程是：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @Override
  protected void eventNotificationsCompleted(InterpretableExecution execution) {
    TransitionImpl transition = execution.getTransition();
    ActivityImpl destination = null;
    if(transition == null) { // this is null after async cont. -&gt; transition is not stored in execution
      destination = (ActivityImpl) execution.getActivity();
    } else {
      destination = transition.getDestination();
    }    
    ActivityImpl activity = (ActivityImpl) execution.getActivity();
    if (activity!=destination) {
      ActivityImpl nextScope = AtomicOperationTransitionNotifyListenerTake.findNextScope(activity, destination);
      execution.setActivity(nextScope);
      //进入了scope，创建scope
      execution.performOperation(TRANSITION_CREATE_SCOPE);
    } else {
      //在这个地方设置了Transition为null
      execution.setTransition(null);
      //终于设置了目标activity
      execution.setActivity(destination);
      execution.performOperation(ACTIVITY_EXECUTE);
    }
  }
</code></pre></div></div>
<p>所以总体的循环就是：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PROCESS_START = new AtomicOperationProcessStart
||
PROCESS_START_INITIAL = new AtomicOperationProcessStartInitial();
||
ACTIVITY_EXECUTE（执行） = new AtomicOperationActivityExecute();
||
TRANSITION_NOTIFY_LISTENER_END = new AtomicOperationTransitionNotifyListenerEnd();
||
TRANSITION_DESTROY_SCOPE = new AtomicOperationTransitionDestroyScope();
||
TRANSITION_NOTIFY_LISTENER_TAKE，TRANSITION_NOTIFY_LISTENER_END（第二种情况就是再次的循环一次）
||
TRANSITION_CREATE_SCOPE（创建） = new AtomicOperationTransitionCreateScope();
||
TRANSITION_NOTIFY_LISTENER_START = new AtomicOperationTransitionNotifyListenerStart();
||
TRANSITION_CREATE_SCOPE（再次创建），ACTIVITY_EXECUTE（再次进入）
</code></pre></div></div>

<p>这个就是节点转移的全过程：</p>
<blockquote>
  <p><strong>转移的过程主要的逻辑点：
1.拿到目标节点（dedestination），Scope就是包含活动节点之类的元素（子流程）开始和结束的时候的处理。</strong>       <br />
<strong>2.转移过程中监听事件的发送。</strong>          <br />
<strong>3.节点的执行，根据各个节点的Behavior运行。</strong>
选择那条线，以及流程定义中不同节点的判断全部的放在了Behavior中了</p>
</blockquote>



                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/activiti-desigen-pattern/2017/08/13/activiti6/" data-toggle="tooltip" data-placement="top" title="activiti和设计模式(6)">
                        Previous<br>
                        <span>activiti和设计模式(6)</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/activiti-desigen-pattern/2017/08/13/activiti8/" data-toggle="tooltip" data-placement="top" title="activiti和设计模式(8)">
                        Next<br>
                        <span>activiti和设计模式(8)</span>
                        </a>
                    </li>
                    
                </ul>


                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
                <!-- 网易云跟帖 评论框 start -->
                <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
                <!-- 网易云跟帖 评论框 end -->
                
            </div>

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">
                <!-- Featured Tags -->
              <!--    -->
                <!-- <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5> -->
                 <!--    <div class="tags">
        				 
                            
        				
                            
                				<a href="/tags/#学习" title="学习" rel="22">
                                    学习
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#JDK" title="JDK" rel="10">
                                    JDK
                                </a>
                            
        				
                            
                				<a href="/tags/#LeetCode" title="LeetCode" rel="6">
                                    LeetCode
                                </a>
                            
        				
        			</div> -->
               <!--  </section> -->
               <!--   -->

                <!-- Friends Blog -->
               <!--   -->
            </div>
        </div>
    </div>
</article>



<!-- 网易云跟帖JS代码 start -->
<script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
<script>
  var cloudTieConfig = {
    url: document.location.href,
    sourceId: "",
    productKey: "de25fc98a6fe48b3bc8a7ae765da99a0",
    target: "cloud-tie-wrapper"
  };
  var yunManualLoad = true;
  Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script>
<!-- 网易云跟帖JS代码 end -->




<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "https-andihappy-github-io-2";
    var disqus_identifier = "/activiti-desigen-pattern/2017/08/13/activiti7";
    var disqus_url = "http://localhost:4000/activiti-desigen-pattern/2017/08/13/activiti7/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Theme modify by <a href="http://huangxuan.me">飞翔的面包</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=andihappy&repo=andihappy.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
