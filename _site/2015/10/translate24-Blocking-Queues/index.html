<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Concurrence-24-Blocking Queues</title>
  <meta name="description" content="Blocking Queues##### 阻塞队列文章的源地址">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://andihappy.github.io//2015/10/translate24-Blocking-Queues/">
  <link rel="alternate" type="application/rss+xml" title="飞翔的面包" href="http://andihappy.github.io//feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">飞翔的面包</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
          <a class="page-link" href="/">飞翔的面包</a>
          
        
          
        
          
          <a class="page-link" href="/page2/">飞翔的面包</a>
          
        
          
          <a class="page-link" href="/page3/">飞翔的面包</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Concurrence-24-Blocking Queues</h1>
    <p class="post-meta"><time datetime="2015-10-27T00:00:00+08:00" itemprop="datePublished">Oct 27, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h4 id="blocking-queues">Blocking Queues</h4>
<p><br />
##### 阻塞队列
<br />
<a href="http://tutorials.jenkov.com/java-concurrency/blocking-queues.html">文章的源地址</a>
<br /></p>

<p>一个阻塞队列在队列为空的时候，你如果出队，那么将会被阻塞。如果队满的时候，如果入队，也会被阻塞。
一个从空队列出队的线程会被阻塞到其他的线程在这个队列中插入一个元素。同样的一个向满队列插入元素的
线程会被阻塞一直到其他的线程出队或者清理掉所有的队列元素。</p>

<p>下图表示两个线程对阻塞队列的操作：</p>

<p><img src="http://tutorials.jenkov.com/images/java-concurrency-utils/blocking-queue.png" alt="" /></p>

<p>java5中实现阻塞队列的类位于java.util.concurrent中，我们来说一下阻塞队列的原理。</p>

<h5 id="section">阻塞队列的实现</h5>

<p>阻塞队列的实现看起来有点像 Bounded Semaphore 下面是一个简单的实现：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public class BlockingQueue {

  private List queue = new LinkedList();
  private int  limit = 10;

  public BlockingQueue(int limit){
    this.limit = limit;
  }


  public synchronized void enqueue(Object item)
  throws InterruptedException  {
    while(this.queue.size() == this.limit) {
      wait();
    }
    if(this.queue.size() == 0) {
      notifyAll();
    }
    this.queue.add(item);
  }


  public synchronized Object dequeue()
  throws InterruptedException{
    while(this.queue.size() == 0){
      wait();
    }
    if(this.queue.size() == this.limit){
      notifyAll();
    }

    return this.queue.remove(0);
  }

}

</code></pre>
</div>
<p>备注： notifyAll 这个方法在dequeue和enqueue里面，只有当队列的大小到达了界限的时候（0或者最大值）的时候，才会被调用。
如果没有到达界限的时候，调用notifyAll,可能还没有线程在调用dequeue或者enqueue方法。</p>

<p>JDK的实现的简单的阻塞队列：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * @author zhailzh
 * 
 * @Date 2015年10月27日——下午1:57:15
 * 
 */
public class SimplyBlockingQueue {
	final Lock lock = new ReentrantLock();
	final Condition notFull = lock.newCondition();
	final Condition notEmpty = lock.newCondition();

	final Object[] items = new Object[10];
	int putptr, takeptr, count;

	public void put(Object x) throws InterruptedException {
		lock.lock();
		try {
			while (count == items.length) {
				System.out.println("buffer full, please wait");
				notFull.await();
			}
				
			items[putptr] = x;
			//比使用取摸运算要好，因为putptr一直递增的话，有可能超出界限
			if (++putptr == items.length){
				putptr = 0;
			}
				
			++count;
			notEmpty.signal();
		} finally {
			lock.unlock();
		}
	}




	public Object take() throws InterruptedException {
		lock.lock();
		try {
			while (count == 0) {
				System.out.println("no elements, please wait");
				notEmpty.await();
			}
			
			Object x = items[takeptr];
			//比使用取摸运算要好，因为takeptr一直递增的话，有可能超出界限
			if (++takeptr == items.length){
				takeptr = 0;
			}
			--count;
			notFull.signal();
			return x;
		} finally {
			lock.unlock();
		}
	}
	
	public static void main(String[] args) {
		final SimplyBlockingQueue boundedBuffer = new SimplyBlockingQueue();
		
		Thread t1 = new Thread(new Runnable() {
			@Override
			public void run() {
				System.out.println("t1 run");
				for (int i=0;i&lt;1000;i++) {
					try {
						System.out.println("putting value ：" +i );
						boundedBuffer.put(Integer.valueOf(i));
						Thread.sleep(1000);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			}
			
		}) ;
		
		Thread t2 = new Thread(new Runnable() {
			@Override
			public void run() {
				for (int i=0;i&lt;1000;i++) {
					try {
						Object val = boundedBuffer.take();
						System.out.println("消耗了："+val);

						Thread.sleep(5000);
					} catch (InterruptedException e) {
						e.printStackTrace();
					}
				}
			}
			
		}) ;
		
		t1.start();
		t2.start();
	}
}

</code></pre>
</div>

<p>测试结果：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>no elements, please wait
t1 run
putting value ：0
消耗了：0
putting value ：1
putting value ：2
putting value ：3
putting value ：4
消耗了：1
putting value ：5
putting value ：6
putting value ：7
putting value ：8
putting value ：9
消耗了：2
putting value ：10
putting value ：11
putting value ：12
putting value ：13
buffer full, please wait
消耗了：3
</code></pre>
</div>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">飞翔的面包</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>飞翔的面包</li>
          <li><a href="mailto:zlzdbf@gmail.com">zlzdbf@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>描述性的文字</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
